======
Server
======

The server will transfer game events between the clients, and will receive authentification and room managing events from the clients. The server will answer by sending specific events.

.. default-domain:: csharp

Accounts
========

.. namespace:: Accounts

.. class:: GAccount

    .. inherits:: IListener<AuthEvent>

	Class used to listen for incoming AuthEvents, and to manage authentification.

    .. property :: public static GAccounts Instance { get; set; }
	
	Instanciate the account manager.

    .. property :: public Dictionary<Account, Client> ConnectedAccounts { get; set; }
	
	Dictionnary used to associate each connected Account to a Client.

    .. method :: public void OnEvent(AuthEvent e, string[] tags = null)
    
	Method controlling the behavior of the server depending on the received AuthEvent.

    .. method :: public void OnClientDisconnect(Client c)
    
	Remove the account of the disconnected client from the list of all ConnectedAccounts.

    .. method :: private byte Authentify(string login, string password)
    
	Asks the database if the given login/password pair match an existing user. Returns 0 if they match, 1 if the password is invalid, and 2 if they do not match at all.

    .. method :: private bool CreateAccount(SignInEvent sie)
    
	Asks the database to create a new account from the login and password stored in the SignInEvent. Returns true if the account has been create, false otherwise.

    .. method :: public static void Init()
    
	Initialize the Account manager.



EventSystem
===========

View
-----
.. namespace:: EventSystem

.. class:: Event

	Base class, inherited by all events transmitted by an IEventManager. Each class inheriting it must have a parameterless constructor and public attributes, to make the serialization work.

    .. method :: public static Event Deserialize(string data, bool catchInvalidType = false)
    
	Deserializes an event from the XML string generated by the function Event.Serialize.

    .. method :: public string Serialize()
    
	Serializes the event to XML format.
	

.. class:: EventView

	Class used to create an IEventManager and instanciate it.

    .. property :: public static IEventManager Manager { get; set; }
	
	Creates a new IEventManager.

    .. method :: public static void Load()
    
	Instanciates the EventManager.
	

.. class:: IEventManager

	Interface of an event controller.

    .. method :: void Emit(Event e, params string[] tags)
    
	Sends a signal to all IListeners added to this IEventManager instance.

    .. method :: void AddListener<T>(IListener<T> listener, bool MainThreaded)

    
	Adds a Listener to the list of listeners. T inherits Event.

    .. method :: void RemoveListener<T>(IListener<T> listener)
    
	Removes a Listener from the list of listeners. T inherits Event.

    .. method :: void ExecMainThreaded()

    .. property :: Log Log { get; set; }
	
	Prints messages.

    .. property :: Log LogWarning { get; set; }
	
	Prints warnings.

    .. property :: Log LogError { get; set; }
	
	Prints errors. If defined, catches exceptions directly causes by the transmission of an event to a listener. Else, an exception will be raised with the error message.
	

.. class:: IListener<T>

	Interface of all listeners added to an IEventManager. T inherits Event.

    .. method :: void OnEvent(T e, string[] tags = null)
    
	Method called each time an IEvent is sent to an IEventManager in which this IListener has been added.
	

.. class:: ListenableObject

	

    .. method :: public void AddListener(OnNotification listener)
    
	 Adds a Listener to the list of observers.

    .. method :: public void RemoveListener(OnNotification listener)
    
	Removes a Listener from the list of observers.

    .. method :: public void Notify()
    
Controller
----------


.. class:: ListenerInstance

	Internal class

    .. property :: public Type Type { get; set; }
	
	

    .. property :: public object Listener { get; set; }
	
	

    .. property :: bool MainThreaded { get; set; }
	
	

    .. method :: public ListenerInstance(object listener, bool mainThreaded = false)
    
    

    .. method :: public void OnEvent(Event e, string[] tags = null)
    
    

.. class:: WaitingLaunchEvent

	Internal class

    .. property :: public ListenerInstance Listener { get; set; }
	
	

    .. property :: public Event Event { get; set; }
	
	

    .. property :: public string[] Tags { get; set; }
	
	

    .. method :: public WaitingLaunchEvent(ListenerInstance listener, Event e, string[] tags)
    
    

.. class:: EventManager

    .. inherits:: IEventManager

	

    .. property :: internal Dictionary<Type, List<ListenerInstance>> Listeners { get; set; }
	
	Dictionnary that contains all listeners for every subtype of IEvent.

    .. property :: public Event Event { get; set; }
	
	

    .. property :: internal List<ListenerInstance> AllListeners { get; set; }
	
	

    .. property :: internal Queue<WaitingLaunchEvent> EventsToLaunch { get; set; }
	
	

    .. property :: Log Log { get; set; }
	
	Prints messages.

    .. property :: Log LogWarning { get; set; }
	
	Prints warnings.

    .. property :: Log LogError { get; set; }
	
	Prints errors. If defined, catches exceptions directly causes by the transmission of an event to a listener. Else, an exception will be raised with the error message.

    .. method :: void Emit(Event e, params string[] tags)
    
	Sends a signal to all IListeners added to this IEventManager instance.

    .. method :: void AddListener<T>(IListener<T> listener, bool MainThreaded)
    
	Adds a Listener of T to the list of listeners. T inherits Event.

    .. method :: void RemoveListener<T>(IListener<T> listener)
    
	Removes a Listener of T from the list of listeners. T inherits Event.

    .. method :: public void ExecMainThreaded()
    

IO
==

.. class:: IOSystem

    .. method:: public static bool FileExists(string path)
    
    .. method:: public static bool DirectoryExists(string path)
    
    .. method:: public static void CreateFile(string path, string[] allLines = null, bool deletePrevious = false)
    
    .. method:: public static FileStream CreateFile(string path, bool deletePrevious = false)
    
    .. method:: public static void DeleteFile(string path)
    
    .. method:: public static string GetFullPath(string path)
    
    .. method:: public static string[] GetAllFileNames(string directory, bool with_extension = false)
    
    .. method:: public static string[] GetAllLines(string path)

Log
===

Network
=======

model
-----

.. namespace:: Network.model

.. class:: Client

    .. inherits:: ListenableObject
    
	Gets the TCP connection from a Server.Accept() and manage the sending/receiving of events.

    .. property:: private TcpClient TcpClient { get; set; }
    
	TCPClient of the client.

    .. property:: private Thread ListenThread { get; set; }
    
	

    .. property:: private NetworkStream Stream { get; set; }
    
	Stream on which data will be sent for this client.

    .. property:: public ListenableObject OnDisconnect { get; set; }
    
	Listener waiting for this client to disconnect.

    .. property:: public static List<OnNotification> OnConnect { get; set; }
    
	

    .. property:: public Room Room { get; set; }
    
	Room in which this client is.

    .. property:: public Account Account { get; set; }
    
	Account associated with this client.
	
    .. method:: public void JoinRoom(Room new_room)
    
	Add this client to a Room.
	
    .. method:: public void LeaveRoom()
    
	Removes this client from this Room.
    
    .. method:: public void Stop()
    
	Closes the connection with the client.
    
    .. method:: public void Send(string data)
    
	Sends a string to the client.
    
    .. method:: public void Send(Event e)
    
	Sends an event to this client.
    
    .. method:: private void Listen()
    
	Listens incoming messages from the Client, and tries to serialize them into an Event. If it works, the event will sent in the IEventMAnager; else, it will be transmitted to the client's room.


.. class:: Server
    
	Manages incoming connections.

    .. property:: private TcpListener Listener { get; set; }
    
	

    .. property:: private Thread ListenThread { get; set; }
    
    

    .. property:: private GClient GClient { get; set; }
    
	The client manager of this server.
    
    .. method:: public void Stop()
    
	Stops the server.
    
    .. method:: public void AcceptClients()
    
	Accepts incoming clients.

controller
-----------


.. namespace:: Network.controller

.. class:: GClient

    .. property:: public static GClient Instance { get; set; }
    
    Instance of the client manager
    
    .. property:: private Dictionary<string, Client> ConnectedClients { get; set; }
    
	Dictionnary associating a string to a Client.
	





Properties
==========

Rooms
=====

.. namespace:: Rooms

.. class:: GRooms

    .. inherits:: IListener<RoomEvent>

	Class used to listen for incoming RoomEvents, and to manage authentification.

    .. property :: public static GRoom Instance { get; set; }
	
	Instanciates the room manager.

    .. property :: public Dictionary<int, Room> Rooms { get; set; }
	
	Dictionnary used to associate their code to each Room.

    .. method :: public void OnEvent(RoomEvent e, string[] tags = null)
    
	Method controlling the behavior of the server depending on the received RoomEvent.

    .. method :: public static void Init()
    
	Initializes the Account manager.

    .. method :: public void AddClient(Client c)
    
	Adds a client to the Global Room and adds a listener waiting for the disconnection of this user

    .. method :: public void RemoveClient(Client c)
    
	Removes the client from the Global Room.

    .. method :: public void OnClientDisconnect(Client c)
    
	Removes the client and his account from his room.

    .. method :: public void RemovePlayerFromRoom(Client c, RoomData r, bool notifyClient = true, string leaveMessage = null)
    
	Removes a Client from a Room.

ServerInterface
================


AuthEvents
----------

.. namespace:: ServerInterface.AuthEvents

.. class:: AuthEvent

	Class modelizing an account.

    .. property :: public string Login { get; set; }
	
	Login of the Account.
	
    .. property :: public bool IsLogged { get; set; }
	
	Boolean set to true if someone is logged to this Account, or to false otherwise.

.. class:: AuthEvent

    .. inherits:: ServerOnlyEvent
    
	Base authentification event, inherited by all other authentification events.


event_in
~~~~~~~~~


.. class:: AccountDataEvent

    .. inherits:: AuthEvent
    
	Event to give his Account's data to a client.
    
    .. property :: public Account Account { get; set; }
    
	The object containing the data of the account.
    

.. class:: AssingAccountEvent

    .. inherits:: AuthEvent
    
	Event to assign an Account to a client.
    
    .. property :: public Account Account { get; set; }
    
	The object containing the data of the account.
    

.. class:: AuthInvalidEvent

    .. inherits:: AuthEvent
    
	Event to report the failure of a request to a client.
    
event_out
~~~~~~~~~

.. class:: AskAccountEvent

    .. inherits:: AuthEvent
    
	Event to ask the server informations of an account.
    
    .. property :: public string Login { get; set; }
    
	Login of the account from which to get informations.
    

.. class:: LogInEvent

    .. inherits:: AuthEvent
    
	Event to ask the server to log the client in.
    
    .. property :: public Account Account { get; set; }
    
	The object containing the data of the account.
    
    .. property :: public string Password { get; set; }
    
	The password of the account to which to log in.
    

.. class:: LogOutEvent

    .. inherits:: AuthEvent
    
	Event to ask the server to log out the sending client.

.. class:: LogInEvent

    .. inherits:: AuthEvent
    
	Event to ask the server to create an account, and log the client in with the created account.
    
    .. property :: public Account Account { get; set; }
    
	The object containing the data of the account.
    
    .. property :: public string Password { get; set; }
    
	The password of the account to which to log in.   


RoomEvents
----------
.. namespace:: ServerInterface.RoomEvents

.. class:: RoomData

	This class countains all the informations about a Room.
	
    .. property :: public int Code { get; set; }
	
	An integer used to identify a Room. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public int CurrentNbPlayer { get; set; }
	
	The number of players currently in the room. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public bool IsSuppressed { get; set; }
	
	Boolean set to true if this Room is currently active, false otherwise. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public bool IsLaunched { get; set; }
	
	Boolean set to true if a game is currently being played in this Room. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public string[] Players { get; set; }

       A list of the logins of all the players in the Room. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public bool[] ReadyPlayers { get; set; }
	
	A list of booleans associated with the Players property; if Players[1] is ready to play, then ReadyPlayers[1] will be set to true, false otherwise. This field will be filled by the server: what the client will write here will not be used.
	
    .. property :: public string Name { get; set; }
	
	The name of the Room.
	
    .. property :: public int MaxNbPlayer { get; set; }
	
	The maximum number of players a Room can accept.
	
    .. property :: public bool HasPassword { get; set; }
	
	A boolean set to true if the Room has a password, false otherwise.
	
    .. property :: public string Password { get; set; }
	
	The password of the Room.
	
	
.. namespace:: ServerInterface.RoomEvents

.. class:: RoomEvent

    .. inherits:: ServerOnlyEvent

	Basic event, from which inherits all events related to the rooms.
	
    .. property :: public RoomData RoomData { get; set; }
	
	The informations of this Room.
	
	
event_in
~~~~~~~~~

.. class:: RoomDataEvent

    .. inherits:: RoomEvent
    
	Event to inform all clients of the state of every Room.
    
.. class:: RoomFailureEvent

    .. inherits:: RoomEvent
    
	Event to notify a client of the failure of his request. 
    
.. class:: RoomJoinedEvent

    .. inherits:: RoomEvent

	Event to inform a client that he has been added to a Room.

.. class:: RoomLeavedEvent

    .. inherits:: RoomEvent

	Event to inform a client that he has been removed from a Room.

event_out
~~~~~~~~~    

.. class:: CreateRoomEvent

    .. inherits:: RoomEvent
    
	Event to ask the server to create a Room, using RoomData.
    
.. class:: JoinRoomEvent

    .. inherits:: RoomEvent
    
	Event ask the server to join a Room. 
    
.. class:: LeaveRoomEvent

    .. inherits:: RoomEvent
    
	Event ask the server to leave a Room.
    
.. class:: ModifyRoomEvent

    .. inherits:: RoomEvent

	Event to ask the server to modify a Room, using the new RoomData.

.. class:: ReadyEvent

    .. inherits:: RoomEvent

	Event to notify the server that the sending client is ready to play.
	
Settings
========

